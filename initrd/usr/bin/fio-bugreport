#!/bin/sh
#-----------------------------------------------------------------------------
#  Copyright 2006-2011 Fusion-io, Inc. All rights reserved.
#
#  No part of this source code may be reproduced or transmitted in any form or
#  by any means, electronic or mechanical, including photocopying, recording,
#  or any information storage and retrieval system, without express written
#  permission from Fusion-io. Further, no use of this source code is permitted
#  in any form or means without a valid, written license agreement with
#  Fusion-io. Please refer to the included "License" or "License.txt" file for
#  terms and conditions regarding the use and redistribution of this
#  software. Acceptance of the terms and conditions of the license set forth in the
#  included "License" or "License.txt" file shall govern rights granted to use this
#  source code. While every precaution has been taken in the preparation of this
#  source code, Fusion-io assumes no responsibility for errors, omissions, or
#  damages from the use of the source code contained herein.
#
#  NEITHER FUSION-IO, ANY MEMBER OF FUSION-IO, NOR ANY PERSON OR ORGANIZATION
#  ACTING ON BEHALF OF THEM MAKES ANY WARRANTY OR REPRESENTATION WHATSOEVER,
#  EXPRESS OR IMPLIED, INCLUDING ANY WARRANTY OF MERCHANTABILITY OR FITNESS
#  OF ANY PURPOSE WITH RESPECT TO THE SOURCE CODE OR ASSUMES ANY LIABILITY
#  WHATSOEVER WITH RESPECT TO ANY USE OF THE SOURCE CODE OR ANY PORTION
#  THEREOF OR WITH RESPECT TO ANY DAMAGES WHICH MAY RESULT FROM SUCH USE.
#-----------------------------------------------------------------------------

# Force bash, if present
if [ -f /bin/bash ]; then
  if [ -z "$BASH_VERSION" ]; then
    /bin/bash $0
    exit
  fi
fi

set -u
set -e
# set -x

# Check for root permissions
if [ `id | sed 's/uid=\([0-9]*\).*/\1/'` != "0" ] ; then
   echo "Error:  $0 must be run as root, or via sudo"
   exit 1
fi

BUGREPORT_VERSION=1

TMPDIR=$(mktemp -d "/tmp/fio-bugreport-$(date +%Y%m%d.%H%M%S)-XXXXXX") || exit 1

DIRNAME=$(echo $TMPDIR | sed -e 's@/*$@@;s@.*/@@')

cd $TMPDIR

host_os=`uname -s`-`uname -r`

# VMware ESX reports as Linux;  we'll make all ESX/ESXi's have a common host_os
if [ -x "$(which vmware)" ]; then
    vmware_version=$(vmware -v | sed -e 's/ /_/g')
    case $vmware_version in
        *ESX_4\.0\.*)
            host_os="VMware-ESX-4.0.0"
            ;;
        *ESX_4\.1\.*)
            host_os="VMware-ESX-4.1.0"
            ;;
        *ESXi_4\.1\.*)
            host_os="VMware-ESXi-4.1.0"
            ;;
        *ESXi_5\.0\.*)
            host_os="VMware-ESXi-5.0.0"
            ;;
        *)
            host_os="VMware-unknown"
            ;;
    esac
fi

echo "OS: $host_os"

# deal with ESXi's lack of bzip
case $host_os in
VMware-ESXi-*)
    TARFILE="$TMPDIR.tar.gz"
    ;;
*)
    TARFILE="$TMPDIR.tar.bz2"
    ;;
esac

# NOTE: This should remain as the first line of successful output so that parsers can easily locate the output file.
echo "Report output: $TARFILE"

if [ -e "$TARFILE" ]; then
    echo "$TARFILE already exists, aborting!"
    exit 1
fi
touch "$TARFILE"
chmod 600 "$TARFILE"

# Set path if appropriate
case $host_os in
SunOS*)
    export PATH=/opt/fusionio/bin:$PATH
    ;;
Darwin*)
    export PATH=/opt/local/fusion-io/bin:$PATH
    ;;
esac

# Remove Linux's alias of ls='ls --color=auto'
unalias -a
unset LS_COLORS
LS="ls -1"
CP="cp -pRP"

cmd_data () {
    local dir="$1" ; shift
    local cmd="$1" ; shift
    local cmd_name=$(echo "$cmd $@" | sed -e 's/\\/_/g;s/\*/_/g;s/ /_/g;s/\//_/g;s/_*$//')
    echo -n "Collecting $cmd $@..."

    mkdir -p "$dir"
    "$cmd" "$@" > "$dir/$cmd_name" 2>&1 || true
    echo "   done"
}

cmd_data_per_fct () {
    for fct in $($LS /dev/fct*) ; do
        # XXX doesn't handle options with spaces
        newcmd=$(echo $@ | sed -e "s@XXFCTXX@$fct@g")
        # The following can't be quoted
        cmd_data $newcmd
    done
}

file_data () {
    local dir="$1" ; shift
    echo -n "Collecting $dir file(s)..."

    mkdir -p "$dir"
    ( $CP "$@" "$dir"/ 2>&1 || true ) | sed -e '/Permis/d;/Invalid/d;/No such/d;/Input.output error/d;/Operation not supported/d'
    echo "   done"
}

cmd_collect_properties () {
    local dir="$1" ; shift
    local cmd="fio-proctl"
    local cmd_name=$(echo "$cmd $@" | sed -e 's/\\/_/g;s/\*/_/g;s/ /_/g;s/\//_/g;s/_*$//')

    mkdir -p "$dir"
    echo -n "Collecting $cmd $@..."
    IFS=$'\n'
    for line in $($cmd $@ 2>&1 || true); do
        echo -n "$line" >> $dir/$cmd_name
        echo ": " >> $dir/$cmd_name
        echo "$($cmd $@ $line 2>&1 || true)" >> $dir/$cmd_name
    done
    unset IFS
    echo "   done"
}

cmd_collect_properties_per_fct () {
    for fct in $($LS /dev/fct*) ; do
        newcmd=$(echo $@ $fct)
        cmd_collect_properties $newcmd
        break
    done
}

# echo -n "Generating debug dumps..."
# echo t > /proc/sysrq-trigger
# echo z > /proc/sysrq-trigger
# echo " done"

echo "$BUGREPORT_VERSION" > version

#
# Package listings
#
case $host_os in
Linux*|VMware-ESX-*)
    cmd_data packages dpkg -l
    cmd_data packages rpm
    ;;

SunOS*)
    cmd_data packages pkglist
    ;;

VMware-ESXi-*)
    cmd_data packages esxupdate query
    ;;
esac

#
# directCache status
#
case $host_os in
*)
    cmd_data iodrive  dc-status -v
    cmd_data iodrives dc-status -fk
    ;;
esac

#
# iodrive diagnostic info
#
# Each of the fio-??? commands are broken up
# into different case statement since some
# may not be supported on all platforms.
# Who doesn't have fio-status though?
case $host_os in
*)
    cmd_data iodrives fio-status -a
    cmd_data iodrives fio-status -fk
    cmd_data iodrives fio-status
    ;;
esac

case $host_os in
Linux*|VMware-ESX-*)
    cmd_data iodrives fio-pci-check -v
    cmd_data iodrives fio-pci-check
    cmd_data iodrives fio-pci-check -f
    cmd_data iodrives fio-pci-check -vvf
    ;;
esac

case $host_os in
Linux*|SunOS*|VMware-ESX-*|Darwin*)
    cmd_data_per_fct iodrives fio-read-lebmap XXFCTXX /dev/stdout
    cmd_data_per_fct iodrives fio-read-lebmap -m XXFCTXX /dev/stdout
    ;;
esac

case $host_os in
Linux*|SunOS*|VMware-ESX-*|Darwin*)
    cmd_data_per_fct iodrives fio-get-erase-count XXFCTXX
    cmd_data_per_fct iodrives fio-get-erase-count -b XXFCTXX
esac

case $host_os in
Linux*|VMware-ESX-*)
    cmd_data iodrives fio-dump-mid
    ;;
esac

# SunOS does not have /proc, so we'll get information out of fio-proctl
case $host_os in
SunOS*)
    cmd_collect_properties_per_fct iodrives
    ;;
Darwin*)
    cmd_collect_properties_per_fct iodrives
    ;;
esac

# VMware has some common data
case $host_os in
VMware-*)
    cmd_data modules vmkload_mod -l
    cmd_data modules esxcfg-module -l
    cmd_data modules esxcfg-scsidevs -l
    cmd_data modules esxcfg-scsidevs -c
    cmd_data modules esxcfg-scsidevs -u
    cmd_data modules esxcfg-scsidevs -m
    cmd_data modules esxcfg-scsidevs -a
    cmd_data system esxcfg-info
    cmd_data system vm-support
    file_data system /var/tmp/esx-*.tgz
    ;;
esac

case $host_os in
VMware-ESX-*)
    file_data logs /var/log/vmkernel*
    ;;
esac

# Fetch platform specific items
case $host_os in
Linux*|VMware-ESX-*)
    cmd_data system lspci
    cmd_data system lspci -vvvvv
    cmd_data system lspci -tv
    cmd_data system lspci -n
    cmd_data system uname -a
    cmd_data system hostname
    file_data logs /var/log/messages*
    file_data logs /var/log/syslog*
    file_data logs /var/log/warn*
    file_data logs /var/log/fusionio/*
    cmd_data logs dmesg
    file_data perf /var/log/sa /var/log/sysstat
    cmd_data perf sar -A
    cmd_data perf sar -r
    cmd_data perf sar
    cmd_data modules lsmod

    # This proc needs to come first
    file_data proc \
        /proc/buddyinfo \
        /proc/cgroups \
        /proc/cmdline \
        /proc/config* \
        /proc/cpuinfo \
        /proc/devices \
        /proc/diskstats \
        /proc/dma \
        /proc/drbd \
        /proc/filesystems \
        /proc/interrupts \
        /proc/iomem \
        /proc/ioports \
        /proc/kallsyms \
        /proc/locks \
        /proc/mdstat \
        /proc/meminfo \
        /proc/misc \
        /proc/modules \
        /proc/mounts \
        /proc/mtrr \
        /proc/pagetypeinfo \
        /proc/partitions \
        /proc/sched_debug \
        /proc/schedstat \
        /proc/slabinfo \
        /proc/softirqs \
        /proc/stat \
        /proc/swaps \
        /proc/timer_list \
        /proc/timer_stats \
        /proc/uptime \
        /proc/version_signature \
        /proc/vmallocinfo \
        /proc/version \
        /proc/vmstat \
        /proc/zoneinfo

    # Symlinks may point here, get them
    file_data proc/self \
        /proc/self/mounts \
        /proc/self/net
    file_data proc /proc/fusion
    file_data proc /proc/sys
    file_data proc /proc/irq
    file_data proc /proc/bus
    file_data proc /proc/fs
    file_data proc /proc/net
    file_data proc /proc/scsi
    file_data proc /proc/sysvipc

    # Have to limit /sys as there are files that will cause cp to get stuck
    file_data sys /sys/block
    file_data sys /sys/bus
    file_data sys /sys/module
    file_data sys /sys/fs
    file_data sys /sys/devices
    cmd_data system dmidecode
    cmd_data modules find /lib/modules
    file_data system /etc/*release
    file_data raid /etc/mdadm/mdadm.conf /etc/mdadm.conf
    cmd_data raid pvs
    cmd_data raid vgs
    cmd_data raid lvs
    file_data raid /proc/drbd /etc/drbd.conf
    file_data system /etc/fstab /etc/mtab
    file_data init /etc/init.d/iomemory-vsl /etc/modprobe.d/iomemory-vsl.conf /etc/sysconfig/iomemory-vsl

    # Perf snapshot
    cmd_data perf iostat -m 1 5 &
    cmd_data perf vmstat 1 5 &
    wait
    cmd_data perf top -n 1
    cmd_data perf ps aux
    cmd_data perf ps aux --sort start_time

    # NUMA information
    cmd_data numa numactl --hardware
    cmd_data numa numactl --show
    cmd_data numa numastat
    ;;


VMware-ESXi-*)
    cmd_data system vib-env
    cmd_data system lspci
    cmd_data system lspci -p
    cmd_data system lspci -vd
    cmd_data system vmkchkdev -L
    cmd_data system df -k
    cmd_data system vdf
    cmd_data system cim-diagnostic.sh
    ;;

SunOS*)
    cmd_data modules modinfo -w
    file_data logs /var/adm/messages*
    file_data logs /var/log/syslog*
    file_data logs /var/log/fusionio/*
    cmd_data system uname -a
    cmd_data system hostname

    cmd_data system prtconf -D
    cmd_data system prtconf -v

    cmd_data zfs zpool list
    cmd_data zfs zfs list

    # Perf snapshot
    cmd_data perf iostat -m 1 5 &
    cmd_data perf vmstat 1 5 &
    wait
    cmd_data perf top -n 1
    cmd_data perf ps aux
    ;;

Darwin*)
    cmd_data system uname -a
    cmd_data system hostname

    cmd_data system kextstat

    file_data logs /var/log/kernel.log
    file_data logs /var/log/system.log
    ;;
esac

# Build the tar
cd /tmp
echo
echo "Building tar file..."
case $host_os in
VMware-ESXi-*|SunOS*|Darwin*)
    find "$DIRNAME" -type f | xargs chmod -R u+rw;
    ;;
esac

case $host_os in
VMware-ESXi-*)
    tar czf "$TARFILE" "$DIRNAME"
    ;;
SunOS*)
    tar cf - "$DIRNAME" | bzip2 > "$TARFILE"
    ;;
Darwin*)
    tar cjf "$TARFILE" "$DIRNAME"
    ;;
*)
    tar cjf "$TARFILE" --mode=u+rw "$DIRNAME"
    ;;
esac

echo
echo "Please attach the bugreport tar file"
echo "    $TARFILE"
echo "  to your support case, including steps to reproduce the problem,"
echo "    and upload or email to customer support."

# vim: set softtabstop=4 shiftwidth=4 expandtab :
